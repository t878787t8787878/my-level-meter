<!DOCTYPE html>
<html>
<head>
  <title>手機水平儀 (除錯版)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: #f0f0f0; font-family: sans-serif; overflow: hidden; }
    #level-container { width: 200px; height: 200px; border: 4px solid #333; border-radius: 50%; position: relative; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    #bubble { width: 40px; height: 40px; background-color: rgba(0, 150, 255, 0.7); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.1s ease-out; }
    #center-mark { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
    #center-mark::before, #center-mark::after { content: ''; position: absolute; background-color: #ccc; }
    #center-mark::before { width: 100%; height: 1px; }
    #center-mark::after { width: 1px; height: 100%; }
    #permission-button { padding: 15px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 5px; background-color: #00B900; color: white; }
    #data-display { position: absolute; top: 20px; text-align: center; font-size: 16px; color: #555; }
  </style>
</head>
<body>

  <button id="permission-button">點擊我啟用水平儀</button>

  <div id="level-container" style="display:none;">
    <div id="center-mark"></div>
    <div id="bubble"></div>
  </div>
  <div id="data-display" style="display:none;"></div>

  <script>
    const permissionButton = document.getElementById('permission-button');
    const levelContainer = document.getElementById('level-container');
    const bubble = document.getElementById('bubble');
    const dataDisplay = document.getElementById('data-display');
    const containerSize = 200;
    const bubbleSize = 40;
    const maxTilt = 45;

    // 新增：檢查是否在安全連線下
    if (window.location.protocol !== 'https:') {
        alert('錯誤：頁面必須在 HTTPS 安全連線下才能存取感測器。');
        permissionButton.disabled = true;
        permissionButton.textContent = '無法在不安全的連線中使用';
        permissionButton.style.backgroundColor = '#888';
    }

    permissionButton.addEventListener('click', requestOrientationPermission);

    function requestOrientationPermission() {
      try {
        // iOS 13+ 裝置的處理方式
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          alert('偵測到 iOS 裝置，正在請求權限...');
          DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                alert('權限已取得！');
                window.addEventListener('deviceorientation', handleOrientation);
                startApp();
              } else {
                alert('您拒絕了權限請求。');
              }
            })
            .catch(error => {
                alert('請求權限時發生錯誤：' + error);
                console.error(error);
            });
        }
        // Android 或其他裝置的處理方式
        else if (typeof DeviceOrientationEvent !== 'undefined') {
           alert('偵測到 Android 或其他裝置，正在嘗試啟動...');
           window.addEventListener('deviceorientation', handleOrientation);
           startApp();
           // 增加一個超時檢查，以防事件監聽器雖然加上了，卻從未觸發
           setTimeout(() => {
               if(dataDisplay.innerHTML === ''){
                   alert('提示：感測器已啟動，但未收到任何數據。請嘗試搖動手機，或檢查瀏覽器權限設定。');
                   dataDisplay.innerHTML = '等待感測器數據中...';
               }
           }, 2000);
        }
        else {
            alert('錯誤：您的瀏覽器不支援 DeviceOrientationEvent API。');
        }
      } catch (error) {
        alert('執行時發生未預期的錯誤：' + error);
        console.error(error);
      }
    }

    function startApp() {
        permissionButton.style.display = 'none';
        levelContainer.style.display = 'block';
        dataDisplay.style.display = 'block';
    }

    function handleOrientation(event) {
      if(event.beta === null || event.gamma === null) {
          return; // 如果數據無效則不處理
      }
      let beta = event.beta;
      let gamma = event.gamma;
      beta = Math.max(-maxTilt, Math.min(maxTilt, beta));
      gamma = Math.max(-maxTilt, Math.min(maxTilt, gamma));
      const xOffset = (gamma / maxTilt) * (containerSize / 2 - bubbleSize / 2);
      const yOffset = (beta / maxTilt) * (containerSize / 2 - bubbleSize / 2);
      bubble.style.transform = `translate(-50%, -50%) translate(${xOffset}px, ${yOffset}px)`;
      dataDisplay.innerHTML = `前後傾斜 (Beta): ${Math.round(event.beta)}°<br>左右傾斜 (Gamma): ${Math.round(event.gamma)}°`;
    }
  </script>
</body>
</html>